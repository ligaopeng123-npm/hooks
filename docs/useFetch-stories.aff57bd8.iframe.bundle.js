"use strict";(self.webpackChunk_gaopeng123_hooks=self.webpackChunk_gaopeng123_hooks||[]).push([[959],{"./stories/useFetch.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{__namedExportsOrder:()=>__namedExportsOrder,default:()=>useFetch_stories,demo:()=>demo});var fetch_esm_MethodEnum,react=__webpack_require__("./node_modules/.pnpm/react@17.0.2/node_modules/react/index.js"),utils_types_esm=__webpack_require__("./node_modules/.pnpm/@gaopeng123+utils.types@1.1.16-alpha.0/node_modules/@gaopeng123/utils.types/dist/utils.types.esm.js"),utils_file_esm=__webpack_require__("./node_modules/.pnpm/@gaopeng123+utils.file@1.1.16-alpha.3/node_modules/@gaopeng123/utils.file/dist/utils.file.esm.js");!function(MethodEnum){MethodEnum.get="GET",MethodEnum.post="POST",MethodEnum.put="PUT",MethodEnum.del="DELETE",MethodEnum.patch="PATCH"}(fetch_esm_MethodEnum||(fetch_esm_MethodEnum={}));var isAbortError=function isAbortError(error){var _ref;return null==(_ref=""+error)?void 0:_ref.includes("The user aborted a request.")};var __fetch__=null;var createFetch=function createFetch(url,options){var opt=Object.assign({responseType:"json"},options);opt.abortController&&opt.abortController.signal&&(opt.signal=opt.abortController.signal,delete opt.abortController),null!=options&&options.body&&((0,utils_types_esm.Kn)(options.body)||(0,utils_types_esm.kJ)(options.body))?opt.body=JSON.stringify(options.body):null!=options&&options.params&&((0,utils_types_esm.Kn)(options.params)||(0,utils_types_esm.kJ)(options.params))&&(url+=(0,utils_file_esm.jT)(null==options?void 0:options.params));var headers=(0,utils_types_esm.Qr)(opt.headers)?opt.headers:Object.assign({"Content-Type":"application/json"},opt.headers);return new Promise((function(resolve,reject){var _Object$assign=Object.assign({times:0,delay:0},opt.retry),times=_Object$assign.times,delay=_Object$assign.delay;!function fetchLoop(){var fetchHandleError=function fetchHandleError(error){isAbortError(error)?console.error(error):times?(times--,setTimeout(fetchLoop,delay)):(console.error(url+"请求出错，",error),reject(url+"请求出错，"+error))};__fetch__(url,Object.assign({},opt,{headers})).then((function(res){if(null!=res&&res.clone){var data=res.clone();if(data.status>=200&&data.status<300)if(opt.noModification)resolve(res);else{var responseType=opt.responseType||"json";resolve(data[responseType]?data[responseType]():res)}else fetchHandleError(function errorCode(code){var message="";switch(code){case 400:message="请求错误";break;case 401:message="未授权，请登录";break;case 403:message="拒绝访问";break;case 404:message="请求地址出错";break;case 408:message="请求超时";break;case 500:message="服务器内部错误";break;case 501:message="服务未实现";break;case 502:message="网关错误";break;case 503:message="服务不可用";break;case 504:message="网关超时";break;case 505:message="HTTP版本不受支持";break;default:message="网络错误"}return message}(data.status))}else void 0!==res&&resolve(res)})).catch(fetchHandleError)}()}))};function _extends(){return _extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},_extends.apply(this,arguments)}var triggerEnum,currentCreateFetch=createFetch;!function(triggerEnum){triggerEnum.ctrl="ctrl",triggerEnum.update="update",triggerEnum.auto="auto"}(triggerEnum||(triggerEnum={}));var useFetch=function useFetch(url,options,checkResponse,deps){var _useState=(0,react.useState)(),data=_useState[0],setData=_useState[1],_useState2=(0,react.useState)(""),error=_useState2[0],setError=_useState2[1],_useState3=(0,react.useState)(!0),loading=_useState3[0],setLoading=_useState3[1],_useState4=(0,react.useState)(!1),loaded=_useState4[0],setLoaded=_useState4[1],_useState5=(0,react.useState)(),runId=_useState5[0],setRunId=_useState5[1],_useState6=(0,react.useState)(options),optionsDynamic=_useState6[0],setOptionsDynamic=_useState6[1],send=function send(){var abortController=options.abortController||new AbortController;return currentCreateFetch(url,Object.assign({method:fetch_esm_MethodEnum.get,abortController},options)).then((function(res){setLoading(!1),setData(checkResponse&&(0,utils_types_esm.mf)(checkResponse)?checkResponse(res):res)})).catch((function(e){setLoading(!1),setError(null==e?void 0:e.toString())})),function(){null==abortController||abortController.abort()}},afterEffect=function afterEffect(){return"update"===options.trigger?loaded?send():(setLoaded(!0),function(){}):"ctrl"===options.trigger?runId?send():function(){}:send()};return(0,react.useEffect)((function(){return afterEffect()}),[runId]),(0,react.useEffect)((function(){return afterEffect()}),[optionsDynamic]),(0,react.useEffect)((function(){JSON.stringify(optionsDynamic)!==JSON.stringify(options)&&setOptionsDynamic(options)}),[options]),(0,react.useEffect)((function(){return afterEffect()}),deps||[]),[loading,error,data,{run:function run(){setRunId(Date.now())}}]},useCtrlFetch=function useCtrlFetch(url,options,checkResponse,deps){return useFetch(url,_extends({trigger:triggerEnum.ctrl},options),checkResponse,deps)},useUpdateFetch=function useUpdateFetch(url,options,checkResponse,deps){var _useFetch6=useFetch(url,_extends({trigger:triggerEnum.update},options),checkResponse,deps);return[_useFetch6[0],_useFetch6[1],_useFetch6[2]]},useCreateFetch=function useCreateFetch(method){var ctrRef=(0,react.useRef)({}),abort=function abort(){var _ctrRef$current$abort;ctrRef.current.abortController&&(null==(_ctrRef$current$abort=ctrRef.current.abortController)||_ctrRef$current$abort.abort())};return(0,react.useEffect)((function(){return function(){abort()}}),[]),[{sent:function sent(url,options){abort();var abortController=new AbortController;return ctrRef.current.abortController=abortController,currentCreateFetch(url,Object.assign({method:method||fetch_esm_MethodEnum.get,abortController},options))},abort}]},jsx_runtime=__webpack_require__("./node_modules/.pnpm/react@17.0.2/node_modules/react/jsx-runtime.js");const itemStyle={padding:"0 16px"},TestUseFetch=props=>{const[dep1,setDep1]=(0,react.useState)(1),[dep2,setDep2]=(0,react.useState)(2),[loading,error,data]=function useGet(url,options,checkResponse,deps){var _useFetch=useFetch(url,Object.assign({method:fetch_esm_MethodEnum.get},options),checkResponse,deps);return[_useFetch[0],_useFetch[1],_useFetch[2]]}("/assets/test.json",{},(res=>res.data),[dep1]),[loading1,error1,data1]=function useUpdateGet(url,options,checkResponse,deps){return useUpdateFetch(url,_extends({method:fetch_esm_MethodEnum.get},options),checkResponse,deps)}("/assets/test.json",{params:{dep:dep2}},(res=>res.data)),[loading2,error2,data2,{run}]=function useCtrlGet(url,options,checkResponse,deps){return useCtrlFetch(url,Object.assign({method:fetch_esm_MethodEnum.get},options),checkResponse,deps)}("/assets/test.json",{},(res=>res.data)),[{sent,abort}]=function useGetFetch(){return useCreateFetch(fetch_esm_MethodEnum.get)}();return loading?(0,jsx_runtime.jsx)("span",{children:"loading"}):error?(0,jsx_runtime.jsx)("span",{children:error}):(0,jsx_runtime.jsxs)(react.Fragment,{children:[(0,jsx_runtime.jsx)("h3",{onClick:()=>{setDep1(Math.random())},children:"useGet"}),(0,jsx_runtime.jsxs)("div",{style:{display:"flex",width:500},children:[(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["loading: ",loading]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["error: ",error]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["data: ",JSON.stringify(data,null,2)]})]}),(0,jsx_runtime.jsx)("h3",{onClick:()=>{sent("/assets/test.json").then((res=>{console.log(res)})),setTimeout((()=>{}),1)},children:"useGetFetch"}),(0,jsx_runtime.jsxs)("div",{style:{display:"flex",width:500},children:[(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["loading: ",loading]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["error: ",error]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["data: ",JSON.stringify(data,null,2)]})]}),(0,jsx_runtime.jsx)("h3",{onClick:()=>{setDep2(Math.random()),setTimeout((()=>{setDep2(Math.random())}),5)},children:"useUpdateGet"}),(0,jsx_runtime.jsxs)("div",{style:{display:"flex",width:500},children:[(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["loading: ",loading1]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["error: ",error1]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["data: ",JSON.stringify(data1,null,2)]})]}),(0,jsx_runtime.jsx)("h3",{onClick:run,children:"useCtrlGet"}),(0,jsx_runtime.jsxs)("div",{style:{display:"flex",width:500},children:[(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["loading: ",loading2]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["error: ",error2]}),(0,jsx_runtime.jsxs)("div",{style:itemStyle,children:["data: ",JSON.stringify(data2,null,2)]})]})]})};TestUseFetch.displayName="TestUseFetch";const components_TestUseFetch=TestUseFetch;try{TestUseFetch.displayName="TestUseFetch",TestUseFetch.__docgenInfo={description:"",displayName:"TestUseFetch",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["example/components/TestUseFetch.tsx#TestUseFetch"]={docgenInfo:TestUseFetch.__docgenInfo,name:"TestUseFetch",path:"example/components/TestUseFetch.tsx#TestUseFetch"})}catch(__react_docgen_typescript_loader_error){}var dist=__webpack_require__("./node_modules/.pnpm/@storybook+blocks@7.4.2_74b3ggvk3akyhuq4eydyx3fqim/node_modules/@storybook/blocks/dist/index.mjs");const useFetch_stories={title:"Example/useFetch",component:(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{}),parameters:{layout:"centered",docs:{page:()=>(0,jsx_runtime.jsx)(jsx_runtime.Fragment,{children:(0,jsx_runtime.jsx)(dist.UG,{children:"# useFetch\n\n>注意：如果和@gaopeng123/fetch一起使用，共享拦截器注入的header属性，需要使用initCreateFetch方法把createFeatch函数注入下\n>\n>[在线demo](https://ligaopeng123-npm.github.io/hooks/?path=/story/example-usefetch--demo)\n\n## initCreateFetch\n\n```tsx\nexport { get, post, put, del, patch, createFetch } from \"@gaopeng123/fetch\";\ninitCreateFetch(createFetch);\n```\n\n## 参数\n\n`(url: string, options: Options, checkResponse?: CheckResponse, deps: Array<any>) : [loading, error, data];`\n\n```typescript\ntype Method = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\ntype Options = {\n    method: Method,\n    body?: any; // post请求 参数放在body上\n    params?: any; // get请求 参数拼接在url上\n    responseType?: 'text' | 'json' | 'blob' | 'formData' | 'arrayBuffer';\n    noModification?: boolean, // 是否要根据responseType做数据获取\n    abortController?: AbortController, // 控制fetch abort\n    headers?: {\n        token?: string;\n        [propName: string]: any;\n    };\n}\n\ntype CheckResponse = (props: any) => any;\n\ntype Deps = any[];\n```\n\n## Usage\n\n```tsx\nimport {useGet, usePost, useDel, usePut, usePatch} from \"@gaopeng123/hooks.use-fetch\";\n\nconst TestUseFetch: React.FC<TestUseFetchProps> = (props) => {\n     const [dep1, setDep1] = useState(1);\n    const [dep2, setDep2] = useState(2);\n    const [loading, error, data] = useGet('/assets/test.json', {}, (res) => {\n        return res.data;\n    }, [dep1, dep2]);\n\n    const onClick = () => {\n        setDep1(Math.random())\n    }\n\n    if (loading) {\n        return (<span>loading</span>)\n    }\n\n    if (error) {\n        return (<span>{error}</span>)\n    }\n\n    return (\n        <React.Fragment>\n            <h3 onClick={onClick}>useGet</h3>\n            <div style={{display: 'flex', width: 500}}>\n                <div style={itemStyle}>loading: {loading}</div>\n                <div style={itemStyle}>error: {error}</div>\n                <div style={itemStyle}>data: {JSON.stringify(data, null, 2)}</div>\n            </div>\n            <h3>usePost</h3>\n            <h3>useDel</h3>\n            <h3>usePut</h3>\n            <h3>usePatch</h3>\n        </React.Fragment>\n    )\n};\n\nexport default TestUseFetch;\n```\n\n## useCreateFetch\n\n`创建一个可操作的fetch`\n\n```tsx\nimport {useGetFetch, usePostFetch, useDelFetch, usePutFetch, usePatchFetch} from \"@gaopeng123/hooks.use-fetch\";\n\nconst TestUseFetch: React.FC<TestUseFetchProps> = (props) => {\n const [{\n        sent,\n        abort\n    }] = useGetFetch();\n  \n  \n  return (\n        <React.Fragment>\n            <h3 onClick={() => {\n                sent('/assets/test.json').then(res => {\n                    console.log(res);\n                });\n                setTimeout(() => {\n                    abort();\n                }, 1)\n            }\n            }>useGetFetch</h3>\n        </React.Fragment>\n    )\n}\n\n\n\n```\n\n\n\n## useUpdateFetch\n\n`初始化时不下发，只有当依赖参数变更后才会下发`\n\n```tsx\n// 初次opts赋值时不加载，当opts再次赋值时接口调用；会自动处理接口abort\nconst [opts, setOpts] = useState({});\nuseEffect(()=> {}, [\n  setTimeout(()=> {\n    setOpts({params: {name: 'name'}});\n  }, 5000);\n]);\nconst [loading, error, data] = useUpdateGet('/assets/test.json', opts}, (res) => {\n        return res.data;\n    });\n```\n\n## useCtrlFetch\n\n`初次不加载，只有当依赖参数变更后才会触发查询`\n\n```tsx\n// 初次不加载，当run()时触发接口调用；会自动处理接口abort\nconst [opts, setOpts] = useState({});\nuseEffect(()=> {}, [\n  setTimeout(()=> {\n    run();\n  }, 5000);\n]);\nconst [loading, error, data, {run}] = useCtrlGet('/assets/test.json', opts}, (res) => {\n        return res.data;\n    });\n```\n\n"})})}},tags:["autodocs"],argTypes:{}},demo={args:{},render:()=>(0,jsx_runtime.jsx)(components_TestUseFetch,{})};demo.parameters={...demo.parameters,docs:{...demo.parameters?.docs,source:{originalSource:"{\n  args: {},\n  render: () => {\n    return <TestUseFetch />;\n  }\n}",...demo.parameters?.docs?.source}}};const __namedExportsOrder=["demo"]},"./node_modules/.pnpm/node-fetch@2.6.7/node_modules/node-fetch/browser.js":(module,exports)=>{var global=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==global)return global;throw new Error("unable to locate global object")}();module.exports=exports=global.fetch,global.fetch&&(exports.default=global.fetch.bind(global)),exports.Headers=global.Headers,exports.Request=global.Request,exports.Response=global.Response}}]);